# MC-RPC

Are you a developer creating an application that needs to communicate with a Minecraft server? MC-RPC is exactly what you need!

MC-RPC exposes an API that lets you use [JSON-RPC 2.0](https://www.jsonrpc.org/specification) to interact with a Minecraft server. You can register custom methods and broadcast notifications without worrying about the underlying connection and transport logic.

[**DOWNLOADS HERE**](https://github.com/adrian154/MCWebSocketPlugin/releases)

# Basic usage

MCWS allows applications to connect to servers via WebSocket and send messages serialized using JSON. There are three main types of messages:
* **Events**, messages broadcasted by the server to inform the client that something has happened.
* **Requests**, messages sent by the client asking the server to do something
* **Responses**, messages sent by the server indicating whether a request was successful

The MCWS protocol is very simple. Clients connect to the server and send requests; the server replies with messages indicating whether the request was successful. The server will also send game events like player deaths or console messages.

MCWS can also function in client mode, in which it connects to a list of remote servers. This may be useful if you do not have permission to listen on any port. 

There are four levels of access that clients can have:
* 0: No access
* 1: Game info
    * The client will receive player join, leave, death, and chat events.
* 2: Read-only console access
    * The client will receive game events as well as console message events not visible to in-game players.
* 3: Full console access
    * The receives all events, and can also execute commands as the server.

## `/mcws-addclient`

Usage: `/mcws-addclient <client name> <access level>`

Permission node: `mcws.addclient`

The server will generate a new secret key for that client and store it in the configuration file. Applications can then connect using that ID-secret combo. 

The client ID  must be one word, with no spaces.

The generated key will be sent to the command sender only and is **never logged**; neither is it stored locally for security reasons. For this reason, you should probably run this command from the console, so you can easily copy and paste the key.

## `/mcws-reload`

Usage: `/mcws-reload`

Permission node: `mcws.reload`

The configuration file will be reloaded, and the server will re-attempt to connect to any outgoing hosts which are not currently connected.

## `/mcws-status`

Usage: `/mcws-status`

Permission node: `mcws.status`

The server will list all active client connections. Only authenticated clients will be listed.

# Configuring MCWS

MCWS stores its configuration as JSON because I find YAML quite ugly.

The configuration file has this structure:

* (root object)
	* `clients`: Object
		* **Keys**: client IDs
		* **Value**: Object
			* `accessLevel`: The client's access level
			* `keyHash`: The SHA-256 hash of the client's secret key. **Don't change this, it'll break authentication. Keys are not recoverable.**
			* `clientID`: The client ID again. If this doesn't match the object's key, weird things might happen. 
	* `outgoingHosts`: List of Strings
		* Each outgoing hostname must begin with `ws://`, or they won't be recognized.
	* `defaultAccess`: Number
		* The default access level given to clients which haven't authenticated. This should never be higher than 0 on a production server.
	* `port`: Number
		* The port which MCWS will listen on.
	* `serverIDSecret`: String
		* A long, random string used to identify the server to clients when connecting on outgoing mode. You probably shouldn't change this from the autogenerated value unless it's been compromised.

## Outgoing Mode

You can configure MCWS to connect to a list of hosts instead of having applications connect to the server. This is useful in situations where you may not be able to listen on any ports, such as many budget Minecraft hosting solutions.

# API

By default, the API is hosted on port 1738. All messages are transferred as JSON text.

Clients should include an `id` field containing an integer value to their requests; this will be included in the server's response as a field called `requestID` to indicate which request it is responding to. However, this is not strictly necessary.

# Client to Server Requests

## auth

This request has no minimum access requirement.

```
{
    action: "auth",
    clientID: String,
    secret: String
}
```

`clientID` is the client ID.

`secret` is the secret key, encoded in base64.

If authentication succeeded, the response will have no `error` field. If authentication fails, an error message will be returned under the `error` field:

* **Already authenticated**: The client has already successfully authenticated once. 
* **No such client**: There exists no configured client with the given `clientID`.
* **Missing fields**: A necessary field was missing.
* **Improperly formatted secret**: The provided secret was not well-formed Base64. 
* **Authentication failed**: The provided secret was not correct.

## getOnline

This request requires access level 1 (game info).

```
{
    action: "getOnline"
}
```

If the client doesn't meet the minimum access level requirement, the server will respond with a Not Authorized error.

Response:

```
{
	players: {
		<uuid>: <playername>
	}
}
```

## runCommand

This request requires access level 3 (full console access).

```
{
    action: "runCommand",
    command: String
}
```

If the client doesn't meet the minimum access level requirement, the server will respond with a Not Authorized error.

If the `command` field is missing, the server will respond with an Missing Fields error.

Otherwise, the command is executed and the server indicates success. Note that even if the command is not well-formed, the request will still succeed, but an error message will be printed in the console.

# Server to Client Events

All outbound messages have a `timestamp` field containing a timestamp in milliseconds. This is omitted from the documentation for each message.

## console

This event is only broadcast to clients with at least access level 2 (readonly console access).

```
{
    type: "console",
    threadName: String,
    level: String,
    message: String,
    className: String
}
```

Note that due to limitations with Log4J, the `className` field is currently always "Unknown". Track this issue [here](https://github.com/adrian154/MCWebSocketPlugin/issues/8).

## chat

This event is only broadcast to clients with at least access level 1 (game info).

```
{
    type: "chat",
    uuid: String,
    playerName: String,
    message: String
}
```

## death

This event is only broadcast to clients with at least access level 1 (game info).

```
{
    type: "death",
    uuid: String,
    playerName: String,
    deathMessage: String
}
```

## join

This event is only broadcast to clients with at least access level 1 (game info).

```
{
    type: "join",
    uuid: String,
    playerName: String
}
```

## quit

This event is only broadcast to clients with at least access level 1 (game info).

```
{
    type: "quit",
    uuid: String,
    playerName: String
}
```

## advancement

This event is only broadcast to clients with at least access level 1 (game info).

```
{
	type: "quit",
	uuid: String,
	playerName: String,
	key: String
}
```

The `key` field is a namespaced key, since localization is always handled on the client side.

# Outgoing Mode Security

MCWS provides a simple mechanism for applications to verify that the websocket they're sending credentials to is actually the server. By default, a server ID secret is generated and stored in the configuration file. When the server successfully connects to an outgoing host, it will send the ID secret as a string. You should distribute this secret ID to clients so they can compare the received ID secret with the stored one.

For this reason, **never** add untrusted clients to the outgoing hosts list, as it may enable attackers to impersonate your server and capture other outgoing hosts' credentials.

# Need help?

If you've found a bug or have a question, head over to the [issues](https://github.com/adrian154/MCWebSocketPlugin/issues) section.